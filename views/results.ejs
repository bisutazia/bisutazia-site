<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ピカイチ投票結果｜<%= match.home %> vs <%= match.away %></title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+JP:400,700">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary:#006bb2; --primary-dark:#004080;
      --accent:#ffbe16; --danger:#d32f2f;
      --bg:#f0f2f5; --card:#fff; --text:#222;
      --gold:#ffd700; --shine:#fff7c7;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text)}
    .header{
      background:linear-gradient(90deg,var(--primary),var(--primary-dark));
      color:#fff;text-align:center;padding:1.2rem 0 1rem;
      font-size:1.3rem;font-weight:900;letter-spacing:.02em;
      position:sticky;top:0;z-index:5;box-shadow:0 2px 6px rgba(0,0,0,.18)
    }
    .wrap{max-width:640px;margin:1rem auto;padding:1rem}
    .hero-card{
      background:var(--card);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:1rem .9rem;margin:.6rem 0 1.2rem;position:relative;overflow:hidden
    }
    .match-name{font-weight:900;color:var(--primary);text-align:center;margin:.2rem 0 .8rem;font-size:1.05rem}
    /* あなたのピカイチ：キラキラ&スクショ映え */
    .voted-card{
      background:linear-gradient(135deg,#ffffff 0%, #fff9e8 48%, #ffffff 100%);
      border:2px solid var(--gold);border-radius:18px;padding:1rem .9rem;margin:.2rem 0 1rem;
      text-align:center;position:relative;isolation:isolate;
    }
    .voted-title{font-size:.95rem;color:#666;margin:0 0 .4rem;font-weight:700}
    .player-name{
      font-size:1.6rem;font-weight:900;letter-spacing:.03em;margin:.1rem 0 .2rem;
      color:#222;text-shadow:0 2px 10px rgba(255,215,0,.35);
    }
    .team-badge{
      display:inline-block;font-size:.95rem;font-weight:800;color:var(--primary);
      background:#eaf4ff;border:1px solid #cfe5ff;border-radius:999px;padding:.28rem .7rem;margin:.2rem 0 .3rem;
    }
    .sparkle{
      position:absolute;inset:0;pointer-events:none;z-index:0;
      background:
        radial-gradient(circle at 12% 30%, rgba(255,215,0,.45) 0 6px, transparent 7px),
        radial-gradient(circle at 88% 22%, rgba(255,255,255,.7) 0 5px, transparent 6px),
        radial-gradient(circle at 72% 78%, rgba(255,215,0,.35) 0 7px, transparent 8px);
      animation:spark 2.4s linear infinite;
    }
    @keyframes spark{
      0%{filter:brightness(1) drop-shadow(0 0 0 #ffd70080)}
      50%{filter:brightness(1.15) drop-shadow(0 0 12px #ffd700aa)}
      100%{filter:brightness(1) drop-shadow(0 0 0 #ffd70080)}
    }
    .confetti{position:fixed;inset:0;pointer-events:none;z-index:9}
    /* 円グラフカード */
    .chart-card{
      background:var(--card);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:.9rem;margin:1rem 0 1.2rem;position:relative;
    }
    .chart-box{position:relative;width:100%;padding-bottom:100%}
    .chart-box canvas{position:absolute;inset:0;width:100%!important;height:100%!important}
    .percent-text{text-align:center;font-size:1.05rem;margin:.7rem 0 .2rem}
    .percent-text span{font-weight:900}
    .home{color:#1976d2}.away{color:#d32f2f}

    /* アクション */
    .actions{display:flex;flex-direction:column;align-items:center;gap:.8rem;margin:1rem 0}
    .btn{
      appearance:none;border:none;cursor:pointer;border-radius:999px;
      font-weight:900;letter-spacing:.02em;box-shadow:0 6px 18px rgba(0,0,0,.12);
      padding:.9rem 1.4rem;font-size:1.05rem
    }
    .btn-share{background:linear-gradient(90deg,#ff6f00,#ffc400);color:#fff}
    .btn-ss{background:#fff;color:#222;border:1px solid #ddd}
    .home-link{display:block;margin:.2rem auto 0;text-align:center;color:#006bb2;text-decoration:none;font-weight:700}
    .note{text-align:center;color:#777;font-size:.9rem;margin:.9rem 0}

    /* スクショモード：余計なUIを隠し、映える余白・背景へ */
    .screenshot .header,.screenshot .actions .btn-share,.screenshot .home-link,.screenshot .note{display:none}
    .screenshot body{background:#fff}
    .screenshot .wrap{padding:0 1rem}
    .screenshot .voted-card{margin-top:.6rem;margin-bottom:1rem;border-width:3px}
    .watermark{display:none}
    .screenshot .watermark{
      display:block;position:fixed;left:50%;bottom:10px;transform:translateX(-50%);
      color:#999;font-weight:900;letter-spacing:.08em;font-size:.9rem;opacity:.7
    }
    @media (max-width:480px){
      .player-name{font-size:1.45rem}
      .btn{font-size:1rem}
    }
  </style>
</head>
<body>
  <div class="header">🎉 投票ありがとう！あなたのピカイチを称えます 🎉</div>

  <canvas class="confetti" id="confetti"></canvas>

  <div class="wrap">
    <div class="hero-card">
      <div class="match-name"><%= match.home %> vs <%= match.away %></div>

      <!-- あなたのピカイチ（祝福カード） -->
      <div class="voted-card" id="votedCard" aria-live="polite">
        <div class="sparkle" aria-hidden="true"></div>
        <div class="voted-title">あなたのピカイチ</div>
        <!-- ここはすでに「選手」付き -->
        <div class="player-name" id="playerName"><%= votedPlayer %> 選手</div>
        <div class="team-badge"><%= (votedTeam==='home'? match.home : match.away) %></div>
        <div style="margin-top:.3rem;color:#555;font-size:.95rem">スクショして #ピカイチ投票 #ビスタジア で投稿しよう！</div>
      </div>
    </div>

    <!-- 円グラフ（ホーム/アウェイ比率のみ） -->
    <div class="chart-card">
      <div class="chart-box"><canvas id="voteChart"></canvas></div>
      <p class="percent-text">
        <span class="home"><%= totalVotes.homePercent %>%</span> <%= match.home %>　
        vs　
        <span class="away"><%= totalVotes.awayPercent %>%</span> <%= match.away %>
      </p>
    </div>

    <!-- アクション -->
    <div class="actions">
      <button id="shareBtn" class="btn btn-share">📤 推しをシェアして盛り上げる</button>
      <button id="ssBtn" class="btn btn-ss">📸 スクショモード</button>
      <a href="/" class="home-link">🏠 他の試合もピカイチ投票する</a>
    </div>
    <p class="note">Instagram/TikTok/Threadsでも <strong>#ピカイチ投票</strong> を付けて投稿！</p>
  </div>

  <div class="watermark">PIKAICHI VOTE | BISTAZIA</div>

  <!-- データ埋め込み -->
  <script id="chartData" type="application/json">
    {"home":<%- JSON.stringify(homeVotes) %>,"away":<%- JSON.stringify(awayVotes) %>}
  </script>

  <script>
    // ---- 定数（EJSをJSに安全に埋め込む） ----
    const MATCH_HOME   = "<%- match.home %>";
    const MATCH_AWAY   = "<%- match.away %>";
    const VOTED_TEAM   = "<%- votedTeam %>";
    // ★ここを“選手”付きにします（統一）：以降どこで使っても「◯◯ 選手」
    const VOTED_PLAYER = "<%- votedPlayer %> 選手";
    const HOME_PCT     = <%- totalVotes.homePercent %>;
    const AWAY_PCT     = <%- totalVotes.awayPercent %>;

    // ---- 円グラフ ----
    (function drawChart(){
      const ctx = document.getElementById('voteChart').getContext('2d');
      const raw = JSON.parse(document.getElementById('chartData').textContent);
      const sumHome = Object.values(raw.home).reduce((a,b)=>a+b,0);
      const sumAway = Object.values(raw.away).reduce((a,b)=>a+b,0);
      new Chart(ctx,{
        type:'doughnut',
        data:{ labels:[MATCH_HOME,MATCH_AWAY], datasets:[{ data:[sumHome,sumAway], backgroundColor:['#1976d2','#d32f2f'] }] },
        options:{
          cutout:'68%', responsive:true,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{
              callbacks:{
                label:(c)=>{ const d=c.dataset.data; const tot=(d[0]+d[1])||1; const p=Math.round((c.raw/tot)*100); return `${c.label}: ${p}%`; }
              }
            }
          }
        }
      });
    })();

    // ---- コンフェッティ（軽量） ----
    (function confetti(){
      const cv = document.getElementById('confetti');
      const ct = cv.getContext('2d');
      function resize(){ cv.width = innerWidth; cv.height = innerHeight; }
      addEventListener('resize',resize); resize();
      const N = 160, parts=[];
      for(let i=0;i<N;i++){
        parts.push({
          x: Math.random()*cv.width,
          y: -Math.random()*cv.height*0.5,
          r: 4+Math.random()*4,
          c: ['#ffd700','#ffbe16','#fff3b0','#1976d2','#d32f2f'][Math.floor(Math.random()*5)],
          s: 1+Math.random()*2,
          a: Math.random()*Math.PI*2
        });
      }
      let t0=null, ttl=2200;
      function anim(ts){
        if(!t0) t0=ts;
        const dt=ts-t0; ct.clearRect(0,0,cv.width,cv.height);
        parts.forEach(p=>{
          p.y += p.s; p.x += Math.sin((dt/300)+p.a)*0.6;
          ct.fillStyle=p.c; ct.beginPath(); ct.arc(p.x,p.y,p.r,0,Math.PI*2); ct.fill();
        });
        if(dt<ttl) requestAnimationFrame(anim); else cv.style.display='none';
      }
      requestAnimationFrame(anim);
    })();

    // ---- スクショモード（UIを削ぎ落として映える） ----
    const ssBtn = document.getElementById('ssBtn');
    ssBtn.addEventListener('click',()=>{
      document.documentElement.classList.toggle('screenshot');
      const card = document.getElementById('votedCard');
      card?.scrollIntoView({behavior:'smooth',block:'center'});
      ssBtn.textContent = document.documentElement.classList.contains('screenshot') ? '✅ スクショ完了 → 通常表示へ' : '📸 スクショモード';
      card.style.transition='filter .18s'; card.style.filter='brightness(1.06)';
      setTimeout(()=>{ card.style.filter=''; },240);
    });

    // ---- シェア（Web Share API / クリップボード） ----
    document.getElementById('shareBtn').addEventListener('click', async ()=>{
      const url  = location.href;
      // ★ここも選手名を採用（VOTED_PLAYERは“選手”付き）
      const text = `【ピカイチ投票結果】あなたのピカイチ：${VOTED_PLAYER}\n${MATCH_HOME} ${HOME_PCT}% vs ${MATCH_AWAY} ${AWAY_PCT}%\n#ピカイチ投票 #ビスタジア\n${url}`;
      try{
        if(navigator.share){
          await navigator.share({title:'ピカイチ投票結果', text, url});
        }else{
          await navigator.clipboard.writeText(text);
          alert('共有テキストをコピーしました！お好きなSNSに貼り付けてください。');
        }
      }catch(e){ console.warn(e); }
    });

    // ---- 初期フォーカス＆アクセシビリティ微配慮 ----
    window.addEventListener('load',()=>{
      document.getElementById('playerName')?.focus?.();
    });
  </script>
</body>
</html>
