<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨çµæœï½œ<%= match.home %> vs <%= match.away %></title>

  <!-- â–¼â–¼ è¿½åŠ ï¼šX/Twitterã‚«ãƒ¼ãƒ‰ï¼ˆOGPï¼‰ã§URLã ã‘ã§ã‚‚â€œæ€ªã—ãè¦‹ãˆãªã„â€ â–¼â–¼ -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ç§ã®ãƒ”ã‚«ã‚¤ãƒï¼š<%= votedPlayer %>ï¼ˆ<%= (votedTeam==='home'? match.home : match.away) %>ï¼‰">
  <meta property="og:description" content="<%= match.home %> vs <%= match.away %>ï½œã‚ãªãŸã‚‚æŠ•ç¥¨ã—ã‚ˆã†ï¼ #ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨ #ãƒ“ã‚¹ã‚¿ã‚¸ã‚¢">
  <meta property="og:site_name" content="ãƒ“ã‚¹ã‚¿ã‚¸ã‚¢">
  <!-- ç”»åƒã¯å¾Œè¿°ã®Canvasç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã§ä¿å­˜ã§ããªã„å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã§OK -->
  <meta property="og:image" content="https://bisutazia-site.onrender.com/ogp.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ç§ã®ãƒ”ã‚«ã‚¤ãƒï¼š<%= votedPlayer %>ï¼ˆ<%= (votedTeam==='home'? match.home : match.away) %>ï¼‰">
  <meta name="twitter:description" content="<%= match.home %> vs <%= match.away %>ï½œã‚ãªãŸã‚‚æŠ•ç¥¨ã—ã‚ˆã†ï¼ #ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨ #ãƒ“ã‚¹ã‚¿ã‚¸ã‚¢">
  <meta name="twitter:image" content="/img/pikaichi_og_default.png">
  <!-- â–²â–² OGPã“ã“ã¾ã§ â–²â–² -->

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+JP:400,700">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary:#006bb2; --primary-dark:#004080;
      --accent:#ffbe16; --danger:#d32f2f;
      --bg:#f0f2f5; --card:#fff; --text:#222;
      --gold:#ffd700; --shine:#fff7c7;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text)}
    .header{
      background:linear-gradient(90deg,var(--primary),var(--primary-dark));
      color:#fff;text-align:center;padding:1.2rem 0 1rem;
      font-size:1.3rem;font-weight:900;letter-spacing:.02em;
      position:sticky;top:0;z-index:5;box-shadow:0 2px 6px rgba(0,0,0,.18)
    }
    .wrap{max-width:640px;margin:1rem auto;padding:1rem}
    .hero-card{
      background:var(--card);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:1rem .9rem;margin:.6rem 0 1.2rem;position:relative;overflow:hidden
    }
    .match-name{font-weight:900;color:var(--primary);text-align:center;margin:.2rem 0 .8rem;font-size:1.05rem}

    .voted-card{
      background:linear-gradient(135deg,#ffffff 0%, #fff9e8 48%, #ffffff 100%);
      border:2px solid var(--gold);border-radius:18px;padding:1rem .9rem;margin:.2rem 0 1rem;
      text-align:center;position:relative;isolation:isolate;
    }
    .voted-title{font-size:.95rem;color:#666;margin:0 0 .4rem;font-weight:700}
    .player-name{
      font-size:1.6rem;font-weight:900;letter-spacing:.03em;margin:.1rem 0 .2rem;
      color:#222;text-shadow:0 2px 10px rgba(255,215,0,.35);
    }
    .team-badge{
      display:inline-block;font-size:.95rem;font-weight:800;color:var(--primary);
      background:#eaf4ff;border:1px solid #cfe5ff;border-radius:999px;padding:.28rem .7rem;margin:.2rem 0 .3rem;
    }
    .sparkle{
      position:absolute;inset:0;pointer-events:none;z-index:0;
      background:
        radial-gradient(circle at 12% 30%, rgba(255,215,0,.45) 0 6px, transparent 7px),
        radial-gradient(circle at 88% 22%, rgba(255,255,255,.7) 0 5px, transparent 6px),
        radial-gradient(circle at 72% 78%, rgba(255,215,0,.35) 0 7px, transparent 8px);
      animation:spark 2.4s linear infinite;
    }
    @keyframes spark{
      0%{filter:brightness(1) drop-shadow(0 0 0 #ffd70080)}
      50%{filter:brightness(1.15) drop-shadow(0 0 12px #ffd700aa)}
      100%{filter:brightness(1) drop-shadow(0 0 0 #ffd70080)}
    }
    .confetti{position:fixed;inset:0;pointer-events:none;z-index:9}

    .chart-card{
      background:var(--card);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:.9rem;margin:1rem 0 1.2rem;position:relative;
    }
    .chart-box{position:relative;width:100%;padding-bottom:100%}
    .chart-box canvas{position:absolute;inset:0;width:100%!important;height:100%!important}
    .percent-text{text-align:center;font-size:1.05rem;margin:.7rem 0 .2rem}
    .percent-text span{font-weight:900}
    .home{color:#1976d2}.away{color:#d32f2f}

    .actions{display:flex;flex-direction:column;align-items:center;gap:.8rem;margin:1rem 0}
    .btn{
      appearance:none;border:none;cursor:pointer;border-radius:999px;
      font-weight:900;letter-spacing:.02em;box-shadow:0 6px 18px rgba(0,0,0,.12);
      padding:.9rem 1.4rem;font-size:1.05rem
    }
    .btn-share{background:linear-gradient(90deg,#ff6f00,#ffc400);color:#fff}
    .btn-x{background:#000;color:#fff}
    .btn-ss{background:#fff;color:#222;border:1px solid #ddd}
    .home-link{display:block;margin:.2rem auto 0;text-align:center;color:#006bb2;text-decoration:none;font-weight:700}
    .note{text-align:center;color:#777;font-size:.9rem;margin:.9rem 0}

    /* ã‚¹ã‚¯ã‚·ãƒ§ãƒ¢ãƒ¼ãƒ‰ */
    .screenshot .header,.screenshot .actions .btn-share,.screenshot .home-link,.screenshot .note{display:none}
    .screenshot body{background:#fff}
    .screenshot .wrap{padding:0 1rem}
    .screenshot .voted-card{margin-top:.6rem;margin-bottom:1rem;border-width:3px}
    .watermark{display:none}
    .screenshot .watermark{
      display:block;position:fixed;left:50%;bottom:10px;transform:translateX(-50%);
      color:#999;font-weight:900;letter-spacing:.08em;font-size:.9rem;opacity:.7
    }
    @media (max-width:480px){
      .player-name{font-size:1.45rem}
      .btn{font-size:1rem}
    }

    /* â–¼ è¿½åŠ ï¼šå…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ  â–¼ */
    .share-preview{
      background:var(--card);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08);
      padding:1rem;margin:1rem 0 .6rem
    }
    .share-preview h3{margin:.2rem 0 .6rem;font-size:1rem}
    .share-textarea{
      width:100%;min-height:120px;border:1px solid #e5e7eb;border-radius:12px;padding:.8rem;font-size:.95rem
    }
    .tiny{font-size:.85rem;color:#666;margin-top:.4rem}
    .img-preview{display:flex;justify-content:center;margin-top:.6rem}
    .img-preview canvas{max-width:100%;border:1px solid #eee;border-radius:12px}
  </style>
</head>
<body>
  <div class="header">ğŸ‰ æŠ•ç¥¨ã‚ã‚ŠãŒã¨ã†ï¼ã‚ãªãŸã®ãƒ”ã‚«ã‚¤ãƒã‚’ç§°ãˆã¾ã™ ğŸ‰</div>

  <canvas class="confetti" id="confetti"></canvas>

  <div class="wrap">
    <div class="hero-card">
      <div class="match-name"><%= match.home %> vs <%= match.away %></div>

      <!-- ã‚ãªãŸã®ãƒ”ã‚«ã‚¤ãƒï¼ˆç¥ç¦ã‚«ãƒ¼ãƒ‰ï¼‰ -->
      <div class="voted-card" id="votedCard" aria-live="polite">
        <div class="sparkle" aria-hidden="true"></div>
        <div class="voted-title">ã‚ãªãŸã®ãƒ”ã‚«ã‚¤ãƒ</div>
        <div class="player-name" id="playerName"><%= votedPlayer %> é¸æ‰‹</div>
        <div class="team-badge"><%= (votedTeam==='home'? match.home : match.away) %></div>
        <div style="margin-top:.3rem;color:#555;font-size:.95rem">ã‚¹ã‚¯ã‚·ãƒ§ã—ã¦ #ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨ #ãƒ“ã‚¹ã‚¿ã‚¸ã‚¢ ã§æŠ•ç¨¿ã—ã‚ˆã†ï¼</div>
      </div>
    </div>

    <!-- å††ã‚°ãƒ©ãƒ•ï¼ˆãƒ›ãƒ¼ãƒ /ã‚¢ã‚¦ã‚§ã‚¤æ¯”ç‡ï¼‰ -->
    <div class="chart-card">
      <div class="chart-box"><canvas id="voteChart"></canvas></div>
      <p class="percent-text">
        <span class="home"><%= totalVotes.homePercent %>%</span> <%= match.home %>ã€€
        vsã€€
        <span class="away"><%= totalVotes.awayPercent %>%</span> <%= match.away %>
      </p>
    </div>

    <!-- â–¼ è¿½åŠ ï¼šå…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ç·¨é›†ã€ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div class="share-preview">
      <h3>ğŸ“£ Xï¼ˆTwitterï¼‰ã«æŠ•ç¨¿ã™ã‚‹å†…å®¹ï¼ˆç·¨é›†ã§ãã¾ã™ï¼‰</h3>
      <textarea id="shareText" class="share-textarea"></textarea>
      <div class="tiny">â€» ç«¯æœ«ãŒå¯¾å¿œã—ã¦ã„ã‚Œã°ç”»åƒã‚‚ä¸€ç·’ã«å…±æœ‰ã•ã‚Œã¾ã™ã€‚å¯¾å¿œã—ã¦ã„ãªã„å ´åˆã¯æœ¬æ–‡ã‚³ãƒ”ãƒ¼ã‹ã€ŒXã§é–‹ãã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</div>
      <div class="img-preview"><canvas id="shareCanvas" width="1080" height="1350" aria-label="å…±æœ‰ç”¨ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"></canvas></div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="actions">
      <button id="shareBtn" class="btn btn-share">ğŸ“¤ ãã®ã¾ã¾å…±æœ‰ï¼ˆå¯¾å¿œç«¯æœ«ã¯ç”»åƒä»˜ãï¼‰</button>
      <button id="tweetBtn" class="btn btn-x">ğ• ã§æŠ•ç¨¿ç”»é¢ã‚’é–‹ã</button>
      <button id="copyBtn" class="btn btn-ss">ğŸ“‹ æ–‡é¢ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button id="dlBtn" class="btn btn-ss">ğŸ–¼ï¸ ç”»åƒã‚’ä¿å­˜</button>
      <button id="ssBtn" class="btn btn-ss">ğŸ“¸ ã‚¹ã‚¯ã‚·ãƒ§ãƒ¢ãƒ¼ãƒ‰</button>
      <a href="/" class="home-link">ğŸ  ä»–ã®è©¦åˆã‚‚ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨ã™ã‚‹</a>
    </div>
    <p class="note">Instagram/TikTok/Threadsã§ã‚‚ <strong>#ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨</strong> ã‚’ä»˜ã‘ã¦æŠ•ç¨¿ï¼</p>
  </div>

  <div class="watermark">PIKAICHI VOTE | BISTAZIA</div>

  <!-- ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ -->
  <script id="chartData" type="application/json">
    {"home":<%- JSON.stringify(homeVotes) %>,"away":<%- JSON.stringify(awayVotes) %>}
  </script>

  <script>
    // ---- å®šæ•°ï¼ˆEJSâ†’JSï¼‰ ----
    const MATCH_HOME   = "<%- match.home %>";
    const MATCH_AWAY   = "<%- match.away %>";
    const VOTED_TEAM   = "<%- votedTeam %>";
    const VOTED_PLAYER = "<%- votedPlayer %> é¸æ‰‹";
    const HOME_PCT     = <%- totalVotes.homePercent %>;
    const AWAY_PCT     = <%- totalVotes.awayPercent %>;
    const PAGE_URL     = location.href;

    // ---- å††ã‚°ãƒ©ãƒ• ----
    (function drawChart(){
      const ctx = document.getElementById('voteChart').getContext('2d');
      const raw = JSON.parse(document.getElementById('chartData').textContent);
      const sumHome = Object.values(raw.home).reduce((a,b)=>a+b,0);
      const sumAway = Object.values(raw.away).reduce((a,b)=>a+b,0);
      new Chart(ctx,{
        type:'doughnut',
        data:{ labels:[MATCH_HOME,MATCH_AWAY], datasets:[{ data:[sumHome,sumAway], backgroundColor:['#1976d2','#d32f2f'] }] },
        options:{
          cutout:'68%', responsive:true,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:(c)=>{ const d=c.dataset.data; const tot=(d[0]+d[1])||1; const p=Math.round((c.raw/tot)*100); return `${c.label}: ${p}%`; } } }
          }
        }
      });
    })();

    // ---- ã‚³ãƒ³ãƒ•ã‚§ãƒƒãƒ†ã‚£ ----
    (function confetti(){
      const cv = document.getElementById('confetti');
      const ct = cv.getContext('2d');
      function resize(){ cv.width = innerWidth; cv.height = innerHeight; }
      addEventListener('resize',resize); resize();
      const N = 160, parts=[];
      for(let i=0;i<N;i++){
        parts.push({
          x: Math.random()*cv.width,
          y: -Math.random()*cv.height*0.5,
          r: 4+Math.random()*4,
          c: ['#ffd700','#ffbe16','#fff3b0','#1976d2','#d32f2f'][Math.floor(Math.random()*5)],
          s: 1+Math.random()*2,
          a: Math.random()*Math.PI*2
        });
      }
      let t0=null, ttl=2200;
      function anim(ts){
        if(!t0) t0=ts;
        const dt=ts-t0; ct.clearRect(0,0,cv.width,cv.height);
        parts.forEach(p=>{ p.y += p.s; p.x += Math.sin((dt/300)+p.a)*0.6; ct.fillStyle=p.c; ct.beginPath(); ct.arc(p.x,p.y,p.r,0,Math.PI*2); ct.fill(); });
        if(dt<ttl) requestAnimationFrame(anim); else cv.style.display='none';
      }
      requestAnimationFrame(anim);
    })();

    // ---- å…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã®ç”Ÿæˆï¼ˆâ€œæ€ªã—ãè¦‹ãˆãªã„â€è¦‹å‡ºã—ï¼‹æ•°å€¤ï¼‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼‰ ----
    function buildShareText(){
      return [
        `ğŸ† ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨ï½œ<${MATCH_HOME} vs ${MATCH_AWAY}>`,
        `ç§ã¯ã€Œ${VOTED_PLAYER}ã€ã«æŠ•ç¥¨ã—ã¾ã—ãŸï¼`,
        `ğŸ“Š æŠ•ç¥¨çŠ¶æ³ï¼š${MATCH_HOME} ${HOME_PCT}%ï½œ${MATCH_AWAY} ${AWAY_PCT}%`,
        `ğŸ‘‰ ã‚ãªãŸã‚‚å‚åŠ ï¼š${PAGE_URL}`,
        `#ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨ #ãƒ“ã‚¹ã‚¿ã‚¸ã‚¢`
      ].join('\n');
    }

    // åˆæœŸãƒ†ã‚­ã‚¹ãƒˆã‚»ãƒƒãƒˆ
    const shareTextEl = document.getElementById('shareText');
    shareTextEl.value = buildShareText();

    // ---- å…±æœ‰ç”¨ç”»åƒï¼ˆCanvaé¢¨ã‚«ãƒ¼ãƒ‰ï¼‰ã‚’Canvasã§è‡ªå‹•ç”Ÿæˆ ----
    const can = document.getElementById('shareCanvas');
    const c  = can.getContext('2d');

    function drawShareCard(){
      const W=can.width, H=can.height;
      // èƒŒæ™¯ã‚°ãƒ©ãƒ‡
      const g = c.createLinearGradient(0,0,W,H);
      g.addColorStop(0,'#0f6ab2'); g.addColorStop(1,'#102a44');
      c.fillStyle=g; c.fillRect(0,0,W,H);

      // ãƒˆãƒƒãƒ—å¸¯
      c.fillStyle='#ffd700'; c.fillRect(0,0,W,28);

      // ã‚¿ã‚¤ãƒˆãƒ«
      c.font='bold 54px Noto Sans JP'; c.fillStyle='#ffffff';
      c.textAlign='center'; c.fillText('ç§ã®ãƒ”ã‚«ã‚¤ãƒ', W/2, 140);

      // è©¦åˆå
      c.font='700 34px Noto Sans JP'; c.fillStyle='#e7f1ff';
      c.fillText(`${MATCH_HOME}  vs  ${MATCH_AWAY}`, W/2, 200);

      // é¸æ‰‹åãƒ—ãƒ¬ãƒ¼ãƒˆ
      const plateY = 320;
      c.fillStyle='#fff9e8'; c.strokeStyle='#ffd700'; c.lineWidth=8;
      roundRect(c, 80, plateY-70, W-160, 160, 26, true, true);

      c.fillStyle='#222';
      c.font='900 60px Noto Sans JP';
      c.fillText(`${VOTED_PLAYER}`, W/2, plateY+10);

      c.fillStyle='#0f6ab2';
      c.font='800 32px Noto Sans JP';
      const team = (VOTED_TEAM==='home'? MATCH_HOME : MATCH_AWAY);
      c.fillText(team, W/2, plateY+60);

      // æŠ•ç¥¨çŠ¶æ³ï¼ˆå††å½¢ã‚²ãƒ¼ã‚¸é¢¨ï¼‰
      drawDonut(W/2, 600, 180, HOME_PCT, `${MATCH_HOME} ${HOME_PCT}%`, '#8ec6ff');
      drawDonut(W/2, 900, 180, AWAY_PCT, `${MATCH_AWAY} ${AWAY_PCT}%`, '#ff9e9e');

      // ãƒ•ãƒƒã‚¿ãƒ¼
      c.font='bold 30px Noto Sans JP'; c.fillStyle='#cbd5e1';
      c.fillText('#ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨  #ãƒ“ã‚¹ã‚¿ã‚¸ã‚¢', W/2, H-70);

      // è§’ãƒ­ã‚´ã£ã½ã„é€ã‹ã—
      c.save(); c.globalAlpha=0.15; c.fillStyle='#fff';
      c.font='900 120px Noto Sans JP'; c.translate(W-60, H-40); c.rotate(-Math.PI/6);
      c.textAlign='right'; c.fillText('PIKAICHI', 0, 0); c.restore();
    }

    function roundRect(ctx,x,y,w,h,r,fill,stroke){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      if(fill) ctx.fill(); if(stroke) ctx.stroke();
    }

    function drawDonut(cx, cy, r, pct, label, color){
      const bg = '#1f3b57';
      c.beginPath(); c.strokeStyle=bg; c.lineWidth=26; c.arc(cx,cy,r,0,Math.PI*2); c.stroke();
      const ang = (Math.max(0,Math.min(100,pct))/100)*Math.PI*2 - Math.PI/2;
      c.beginPath(); c.strokeStyle=color; c.lineWidth=26; c.arc(cx,cy,r,-Math.PI/2,ang); c.stroke();
      c.fillStyle='#ffffff'; c.font='900 48px Noto Sans JP'; c.textAlign='center';
      c.fillText(`${pct}%`, cx, cy+14);
      c.fillStyle='#e2e8f0'; c.font='700 30px Noto Sans JP';
      c.fillText(label, cx, cy+70);
    }

    drawShareCard();

    // ç”»åƒBlobå–å¾—
    function canvasToBlob(){
      return new Promise(res=> can.toBlob(b=>res(b),'image/png',0.95));
    }

    // ---- ã‚¹ã‚¯ã‚·ãƒ§ãƒ¢ãƒ¼ãƒ‰ ----
    const ssBtn = document.getElementById('ssBtn');
    ssBtn.addEventListener('click',()=>{
      document.documentElement.classList.toggle('screenshot');
      const card = document.getElementById('votedCard');
      card?.scrollIntoView({behavior:'smooth',block:'center'});
      ssBtn.textContent = document.documentElement.classList.contains('screenshot') ? 'âœ… ã‚¹ã‚¯ã‚·ãƒ§å®Œäº† â†’ é€šå¸¸è¡¨ç¤ºã¸' : 'ğŸ“¸ ã‚¹ã‚¯ã‚·ãƒ§ãƒ¢ãƒ¼ãƒ‰';
    });

    // ---- å…±æœ‰ï¼ˆWeb Share API: ç”»åƒï¼‹ãƒ†ã‚­ã‚¹ãƒˆ / ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰ ----
    document.getElementById('shareBtn').addEventListener('click', async ()=>{
      const text = shareTextEl.value.trim() || buildShareText();
      try{
        const supportsFiles = ('canShare' in navigator);
        const blob = await canvasToBlob();
        const file = new File([blob], 'pikaichi.png', {type:'image/png'});

        if (navigator.share){
          if (supportsFiles && navigator.canShare && navigator.canShare({files:[file]})){
            await navigator.share({title:'ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨', text, files:[file]});
          } else {
            await navigator.share({title:'ãƒ”ã‚«ã‚¤ãƒæŠ•ç¥¨', text, url: PAGE_URL});
          }
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚³ãƒ”ãƒ¼
          await navigator.clipboard.writeText(text);
          alert('å…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ãŠå¥½ããªSNSã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
        }
      }catch(e){ console.warn(e); }
    });

    // ---- Xã§æŠ•ç¨¿ç”»é¢ã‚’é–‹ãï¼ˆintent/tweetï¼‰ ----
    document.getElementById('tweetBtn').addEventListener('click', ()=>{
      const text = encodeURIComponent(shareTextEl.value.trim() || buildShareText());
      const url  = 'https://twitter.com/intent/tweet?text=' + text;
      window.open(url,'_blank','noopener');
    });

    // ---- æ–‡é¢ã‚³ãƒ”ãƒ¼ ----
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const text = shareTextEl.value.trim() || buildShareText();
      try{ await navigator.clipboard.writeText(text); alert('æ–‡é¢ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Xã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼'); }
      catch(e){ console.warn(e); }
    });

    // ---- ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ‰‹å‹•æ·»ä»˜ç”¨ï¼‰----
    document.getElementById('dlBtn').addEventListener('click', async ()=>{
      const a = document.createElement('a');
      a.href = can.toDataURL('image/png');
      a.download = 'pikaichi.png';
      a.click();
    });

    // ---- åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹ ----
    window.addEventListener('load',()=>{ document.getElementById('playerName')?.focus?.(); });
  </script>
</body>
</html>
